--
WITH kuba_data AS 
(
	SELECT DISTINCT
--		CMP.X_COMPLEX_NO,
--		CMP.COMPANY_NO,
		EJJ.JOIN_NO kuba_join_no,
		CMP.COMPANY_NR,
		XKD.JOIN_NR kuba_join_nr
--		CMP.DISPLAY_NAME
	FROM BSI_X_EXT_KUBA_DATA xkd 
		INNER JOIN BSI_X_EXT_JOIN_JOIN ejj
			INNER JOIN BSI_X_EXT_JOIN ej 
			ON EJ.EXT_JOIN_NR = EJJ.EXT_JOIN_NR
			AND EJ.EXT_JOIN_TYPE_UID = EJJ.EXT_JOIN_TYPE_UID
			INNER JOIN BSI_COMPANY cmp
			ON CMP.COMPANY_NR = EJJ.JOIN_NR
		ON EJJ.EXT_JOIN_NR = XKD.JOIN_NR
	WHERE EJJ.IS_MASTER = 0
	AND EJ.INTERFACE_UID NOT IN (108187, 108205) -- samba / nxdsmp, Küba: 131309
	AND EJ.ACTIVE = 1
	ORDER BY CMP.COMPANY_NO
),
master_data AS 
(
	SELECT DISTINCT
--		CMP.X_COMPLEX_NO,
--		CMP.COMPANY_NO,
		ejj.JOIN_NO,
		CMP.COMPANY_NR
--		CMP.DISPLAY_NAME
	FROM BSI_X_EXT_JOIN ej 
		INNER JOIN BSI_X_EXT_JOIN_JOIN ejj
			INNER JOIN BSI_COMPANY cmp
			ON CMP.COMPANY_NR = EJJ.JOIN_NR
		ON EJJ.EXT_JOIN_NR = EJ.EXT_JOIN_NR
		AND EJJ.EXT_JOIN_TYPE_UID = EJ.EXT_JOIN_TYPE_UID
	WHERE EJJ.IS_MASTER = 1
	AND EJ.INTERFACE_UID IN (108187, 108205) -- samba / nxdsmp
	and ej.active = 1
)
SELECT DISTINCT 
--	KBD.X_COMPLEX_NO,
--	MDT.JOIN_NO master_join_no,
--	KBD.COMPANY_NR,
	KBD.kuba_join_no,
	KBD.kuba_join_nr
--	KBD.DISPLAY_NAME kuba_company_name
FROM kuba_data KBD
	INNER JOIN master_data MDT
	ON MDT.COMPANY_NR = KBD.COMPANY_NR
	ORDER BY KBD.X_COMPLEX_NO
;
-- 331’774

-- COUNT-Abfrage:
-- Anzahl der Küba Kunden Datensätze
--
	WITH kuba_data AS 
	(
		SELECT DISTINCT
			CMP.X_COMPLEX_NO
		FROM BSI_X_EXT_KUBA_DATA xkd 
			INNER JOIN BSI_X_EXT_JOIN_JOIN ejj
				INNER JOIN BSI_X_EXT_JOIN ej 
				ON EJ.EXT_JOIN_NR = EJJ.EXT_JOIN_NR
				AND EJ.EXT_JOIN_TYPE_UID = EJJ.EXT_JOIN_TYPE_UID
				INNER JOIN BSI_COMPANY cmp
				ON CMP.COMPANY_NR = EJJ.JOIN_NR
			ON EJJ.EXT_JOIN_NR = XKD.JOIN_NR
--		WHERE CMP.X_COMPLEX_NO = 17173059
		WHERE EJJ.IS_MASTER = 0
		AND EJ.INTERFACE_UID NOT IN (108187, 108205) -- samba / nxdsmp, Küba: 131309
		AND EJ.ACTIVE = 1
		ORDER BY CMP.COMPANY_NO
	)
	SELECT DISTINCT 
		count(*) AS Anzahl
	FROM kuba_data KBD
;
-- 343723
