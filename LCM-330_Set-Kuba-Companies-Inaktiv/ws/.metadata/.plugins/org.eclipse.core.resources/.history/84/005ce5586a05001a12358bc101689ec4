--alter session set current_schema = bsicrm;
set serveroutput on;

DECLARE
--	vCntrlFilecsv utl_file.file_type;
--	buffer_size constant binary_integer := 32760;
--	vFileNamecsv varchar2(200);
--	vDirectoryPath constant varchar2(100) := 'SF_EXPORT';
--	c_Charakterset_DB constant varchar2(30) := 'UTF8';
--	c_Charakterset_Out constant varchar2(30) := 'AL32UTF8'; -- UTF8
--	vTextLine varchar2(8000);
	vErrorText varchar2(4000);
	h number;
--	cr constant varchar2(1) := chr(13); -- Carriage Return

begin

	h := 0;

--	SELECT 'LCM_contacts_'||SUBSTR(global_name,1,6)||'_'||TO_CHAR(sysdate,'YYYYMMDD_HH24MI')||'.csv' into vFileNamecsv FROM global_name;

--	dbms_output.put_line('Export lcm_contacts, FileName '||vFileNamecsv);

--	vCntrlFilecsv := utl_file.fopen(vDirectoryPath, vFileNamecsv,'w', buffer_size);

--	vTextLine     := 'uk_LCM_X_COMPLEX_NO,uk_LCM_PERSON_NR,Salutation,Title,FirstName,LastName,Phone,MobilePhone,Fax,Email,PreferedLanguage__c,MailingStreet,MailingPostalCode,MailingCity,MailingState,MailingCountry';
			
--	utl_file.put_line(vCntrlFilecsv, convert(vTextLine,c_Charakterset_Out,c_Charakterset_DB));
--	utl_file.fflush(vCntrlFilecsv);  -- Schreibpuffer leeren

	for r in 
		(
			-- Abfrage von Küba-emails, welche als bevorzugte email im Master genutzt werden.
			--
			WITH kuba_data AS 
			(
				SELECT DISTINCT
					CMP.X_COMPLEX_NO,
					CMP.COMPANY_NO,
					EJJ.JOIN_NO kuba_join_no,
					CMP.COMPANY_NR,
					XKD.JOIN_NR kuba_join_nr,
					CMP.DISPLAY_NAME
			--		ADR.CHANNEL_VALUE email_address,
			--		ADR.IS_DEFAULT_ADDRESS
				FROM BSI_X_EXT_KUBA_DATA xkd 
					INNER JOIN BSI_X_EXT_JOIN_JOIN ejj
						INNER JOIN BSI_X_EXT_JOIN ej 
						ON EJ.EXT_JOIN_NR = EJJ.EXT_JOIN_NR
						AND EJ.EXT_JOIN_TYPE_UID = EJJ.EXT_JOIN_TYPE_UID
						INNER JOIN BSI_COMPANY cmp
						ON CMP.COMPANY_NR = EJJ.JOIN_NR
--						INNER JOIN BSI_X_ADDRESS_MAPPING adm
			--				INNER JOIN BSI_ADDRESS adr
			--				ON ADR.ADDRESS_NR = ADM.ADDRESS_NR
--						ON ADM.EXT_JOIN_NR = EJJ.EXT_JOIN_NR
			--			AND ADM.JOIN_TYPE_UID = 318594
					ON EJJ.EXT_JOIN_NR = XKD.JOIN_NR
			--	WHERE ADR.CHANNEL_UID = 113641
				--AND CMP.COMPANY_NR = 4951486493 -- Keine KUBA-email 19101387, MIT KUBA-email: 4951486493 (Company_NO = 1440917)
				WHERE EJJ.IS_MASTER = 0
				AND EJ.INTERFACE_UID NOT IN (108187, 108205) -- samba / nxdsmp, Küba: 131309
				AND EJ.ACTIVE = 1
			--	AND ADR.CHANNEL_VALUE IS NOT NULL
				ORDER BY CMP.COMPANY_NO
			)
			SELECT DISTINCT 
				KBD.X_COMPLEX_NO,
		--		MDT.JOIN_NO master_join_no,
				KBD.COMPANY_NR,
			--	KBD.COMPANY_NO,
				kbd.kuba_join_nr,
				KBD.kuba_join_no,
				KBD.DISPLAY_NAME kuba_company_name
			--	KBD.email_address kuba_mail,
			--	MDT.email_address master_mail
			FROM kuba_data KBD
				ORDER BY KBD.X_COMPLEX_NO
	) loop

--		vTextLine := REPLACE('"'||r.uk_LCM_X_COMPLEX_NO||'","'||r.uk_LCM_PERSON_NR||'","'||r.Salutation||'","'||r.Title||'","'||REPLACE(REPLACE(r.FirstName,'"',''''),'''''','''')||'","'||REPLACE(REPLACE(r.LastName,'"',''''),'''''','''')||'","'||r.Phone||
--                    '","'||r.MobilePhone||'","'||r.Fax||'","'||r.Email||'","'||r.PreferedLanguage__c||'
--					","'||REPLACE(REPLACE(r.MailingStreet,'"',''''),'''''','''')||'","'||r.MailingPostalCode||'","'||r.MailingCity||
--					'","'||r.MailingState||'","'||r.MailingCountry||
--					'"','""')||cr;
             
--		utl_file.put_line(vCntrlFilecsv, convert(vTextLine,c_Charakterset_Out,c_Charakterset_DB));
--		utl_file.fflush(vCntrlFilecsv);    -- Schreibpuffer leeren
  
			dbms_output.put_line(r.X_COMPLEX_NO);
			h := h + 1;

		END loop;
  
--		utl_file.fclose(vCntrlFilecsv);  -- Close the file
--		dbms_output.put_line('Anzahl lcm_contacts: '||to_char(h));

	exception WHEN others THEN
		vErrorText := 'Fehler bei lcm_contacts: '||sqlerrm;
		dbms_output.put_line(vErrorText);
END;