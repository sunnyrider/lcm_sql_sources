SELECT
	EJ.INTERFACE_UID || ' - ' || uc_cmp.TEXT company_interface,
	COUNT(DISTINCT CPS.PERSON_NR) AS personen_zu_firma
FROM BSI_X_EXT_JOIN_JOIN ejj
		INNER JOIN BSI_X_EXT_JOIN ej
			INNER JOIN BSI_UC_TEXT uc_cmp ON uc_cmp.UC_UID = EJ.INTERFACE_UID AND uc_cmp.LANGUAGE_UID = 246
		ON EJ.EXT_JOIN_NR = EJJ.EXT_JOIN_NR
		AND EJ.EXT_JOIN_TYPE_UID = EJJ.EXT_JOIN_TYPE_UID
		AND EJ.EXT_JOIN_TYPE_UID = 108224  -- External Company
	INNER JOIN BSI_COMPANY_PERSON cps
		INNER JOIN BSI_PERSON prs ON PRS.PERSON_NR = CPS.PERSON_NR
		AND PRS.IS_ACTIVE = 1
		INNER JOIN BSI_X_EXT_JOIN_JOIN pjj 
			INNER JOIN BSI_X_EXT_JOIN pj
				INNER JOIN BSI_UC_TEXT uc_person ON uc_person.UC_UID = PJ.INTERFACE_UID AND uc_person.LANGUAGE_UID = 246
			ON PJ.EXT_JOIN_NR = PJJ.EXT_JOIN_NR
			AND PJ.EXT_JOIN_TYPE_UID = 108236  -- External Person
		ON PJJ.JOIN_NR = CPS.PERSON_NR
	ON EJJ.JOIN_NR = CPS.COMPANY_NR
WHERE EJ.INTERFACE_UID NOT IN (131309) -- Küba
--AND EJ.ACTIVE = 1
GROUP BY 
EJ.INTERFACE_UID || ' - ' || uc_cmp.TEXT 
;
--COMPANY_INTERFACE	PERSONEN_ZU_FIRMA Company ACTIVE = 1	PERSONEN_ZU_FIRMA Company ACTIVE = 0	DELTA (ACTIVE = 0, ACTIVE = 1)
--108205 - Kunde	625724									715663									89939
--117306 - LCM		24847									24864									17
--108187 - Adresse	301650									349928									48278
--					952221									1090455									138234


SELECT
--	EJ.INTERFACE_UID || ' - ' || uc_cmp.TEXT company_interface,
	COUNT(DISTINCT CPS.PERSON_NR) AS personen_zu_firma
FROM BSI_X_EXT_JOIN_JOIN ejj
		INNER JOIN BSI_X_EXT_JOIN ej
			INNER JOIN BSI_UC_TEXT uc_cmp ON uc_cmp.UC_UID = EJ.INTERFACE_UID AND uc_cmp.LANGUAGE_UID = 246
		ON EJ.EXT_JOIN_NR = EJJ.EXT_JOIN_NR
		AND EJ.EXT_JOIN_TYPE_UID = EJJ.EXT_JOIN_TYPE_UID
		AND EJ.EXT_JOIN_TYPE_UID = 108224  -- External Company
		AND EJ.INTERFACE_UID IN (131309) -- Küba
	INNER JOIN BSI_COMPANY_PERSON cps
		INNER JOIN BSI_PERSON prs ON PRS.PERSON_NR = CPS.PERSON_NR
--		AND PRS.IS_ACTIVE = 1
		INNER JOIN BSI_X_EXT_JOIN_JOIN pjj 
			INNER JOIN BSI_X_EXT_JOIN pj
				INNER JOIN BSI_UC_TEXT uc_person ON uc_person.UC_UID = PJ.INTERFACE_UID AND uc_person.LANGUAGE_UID = 246
			ON PJ.EXT_JOIN_NR = PJJ.EXT_JOIN_NR
			AND PJ.ACTIVE = 1
			AND PJ.EXT_JOIN_TYPE_UID = 108236  -- External Person
			AND PJ.INTERFACE_UID IN (131310)  -- Küba Person
		ON PJJ.JOIN_NR = CPS.PERSON_NR
	ON EJJ.JOIN_NR = CPS.COMPANY_NR
--WHERE EJ.INTERFACE_UID NOT IN (131309) -- Küba
--AND EJ.ACTIVE = 1
--GROUP BY 
--EJ.INTERFACE_UID || ' - ' || uc_cmp.TEXT 
;

--374879