--
-- NUR KüBA Companies
--
SELECT
	EJ.INTERFACE_UID,
	COUNT(DISTINCT CPS.PERSON_NR) AS kuba_personen
FROM BSI_X_EXT_KUBA_DATA kbd 
	INNER JOIN BSI_X_EXT_JOIN_JOIN ejj
		INNER JOIN BSI_X_EXT_JOIN ej ON EJ.EXT_JOIN_NR = EJJ.EXT_JOIN_NR
		AND EJ.EXT_JOIN_TYPE_UID = EJJ.EXT_JOIN_TYPE_UID
	INNER JOIN BSI_COMPANY_PERSON cps
		INNER JOIN BSI_PERSON prs ON PRS.PERSON_NR = CPS.PERSON_NR
		AND PRS.IS_ACTIVE = 1
		INNER JOIN BSI_X_EXT_JOIN_JOIN pjj 
			INNER JOIN BSI_X_EXT_JOIN pj ON PJ.EXT_JOIN_NR = PJJ.EXT_JOIN_NR
--			AND PJ.EXT_JOIN_TYPE_UID = 108236  -- External Person
			AND PJ.INTERFACE_UID = 131310 -- Küba Personen
		ON PJJ.JOIN_NR = CPS.PERSON_NR
	ON CPS.COMPANY_NR = EJJ.JOIN_NR
	ON EJJ.EXT_JOIN_NR = KBD.JOIN_NR
WHERE EJ.EXT_JOIN_TYPE_UID = 108224  -- External Company
--AND EJ.INTERFACE_UID = 131309 -- Küba
--AND EJ.ACTIVE = 1
GROUP BY EJ.INTERFACE_UID
;
--
-- OHNE ES.IS_ACTIVE Zustand
--INTERFACE_UID		KUBA_PERSONEN
-- TEP
-- 131309			374824
-- PROD
-- 131309			370496

SELECT
	COUNT(DISTINCT CPS.PERSON_NR) AS personen_zu_firma,
	EJ.INTERFACE_UID
FROM BSI_COMPANY cmp  
	INNER JOIN BSI_X_EXT_JOIN_JOIN ejj
		INNER JOIN BSI_X_EXT_JOIN ej ON EJ.EXT_JOIN_NR = EJJ.EXT_JOIN_NR
		AND EJ.EXT_JOIN_TYPE_UID = EJJ.EXT_JOIN_TYPE_UID
	ON CMP.COMPANY_NR = EJJ.JOIN_NR
	INNER JOIN BSI_COMPANY_PERSON cps
		INNER JOIN BSI_PERSON prs ON PRS.PERSON_NR = CPS.PERSON_NR
		AND PRS.IS_ACTIVE = 1
		INNER JOIN BSI_X_EXT_JOIN_JOIN pjj 
			INNER JOIN BSI_X_EXT_JOIN pj ON PJ.EXT_JOIN_NR = PJJ.EXT_JOIN_NR
--			AND PJ.EXT_JOIN_TYPE_UID = 108236  -- External Person
			AND PJ.INTERFACE_UID NOT IN (131310)
		ON PJJ.JOIN_NR = CPS.PERSON_NR
	ON CPS.COMPANY_NR = EJJ.JOIN_NR
--WHERE EJ.EXT_JOIN_TYPE_UID = 108224  -- External Company
AND EJ.INTERFACE_UID NOT IN (131309) -- Küba
--AND EJ.INTERFACE_UID IN (108187, 108205) -- samba / nxdsmp, Küba: 131309
--AND EJ.ACTIVE = 1
GROUP BY EJ.INTERFACE_UID
;
-- 744129

-- 671250 mit AND EJ.ACTIVE = 1
-- 668600

SELECT
--	EJ.INTERFACE_UID || ' - ' || uc_cmp.TEXT company_interface,
--	PJ.INTERFACE_UID || ' - ' || uc_person.TEXT person_interface,
	COUNT(DISTINCT CPS.PERSON_NR) AS personen_zu_firma
FROM BSI_X_EXT_JOIN_JOIN ejj
		INNER JOIN BSI_X_EXT_JOIN ej
			INNER JOIN BSI_UC_TEXT uc_cmp ON uc_cmp.UC_UID = EJ.INTERFACE_UID AND uc_cmp.LANGUAGE_UID = 246
		ON EJ.EXT_JOIN_NR = EJJ.EXT_JOIN_NR
		AND EJ.EXT_JOIN_TYPE_UID = EJJ.EXT_JOIN_TYPE_UID
		AND EJ.EXT_JOIN_TYPE_UID = 108224  -- External Company
	INNER JOIN BSI_COMPANY_PERSON cps
		INNER JOIN BSI_PERSON prs ON PRS.PERSON_NR = CPS.PERSON_NR
		AND PRS.IS_ACTIVE = 1
		INNER JOIN BSI_X_EXT_JOIN_JOIN pjj 
			INNER JOIN BSI_X_EXT_JOIN pj
				INNER JOIN BSI_UC_TEXT uc_person ON uc_person.UC_UID = PJ.INTERFACE_UID AND uc_person.LANGUAGE_UID = 246
			ON PJ.EXT_JOIN_NR = PJJ.EXT_JOIN_NR
			AND PJ.EXT_JOIN_TYPE_UID = 108236  -- External Person
			AND PJ.INTERFACE_UID  IN (131310) -- Küba Personen
	ON PJJ.JOIN_NR = CPS.PERSON_NR
ON EJJ.JOIN_NR = CPS.COMPANY_NR
--WHERE EJ.INTERFACE_UID NOT IN (131309) -- Küba
--AND EJ.ACTIVE = 1
--GROUP BY 
--EJ.INTERFACE_UID || ' - ' || uc_cmp.TEXT ,
--PJ.INTERFACE_UID || ' - ' || uc_person.TEXT
;
--PERSONEN_ZU_FIRMA	INTERFACE_UID
--374825			131310
--34281				108205
--396002			117306


SELECT
--	EJ.INTERFACE_UID || ' - ' || uc_cmp.TEXT company_interface,
	COUNT(DISTINCT CPS.PERSON_NR) AS personen_zu_firma
FROM BSI_X_EXT_JOIN_JOIN ejj
		INNER JOIN BSI_X_EXT_JOIN ej
			INNER JOIN BSI_UC_TEXT uc_cmp ON uc_cmp.UC_UID = EJ.INTERFACE_UID AND uc_cmp.LANGUAGE_UID = 246
		ON EJ.EXT_JOIN_NR = EJJ.EXT_JOIN_NR
		AND EJ.EXT_JOIN_TYPE_UID = EJJ.EXT_JOIN_TYPE_UID
		AND EJ.EXT_JOIN_TYPE_UID = 108224  -- External Company
	INNER JOIN BSI_COMPANY_PERSON cps
		INNER JOIN BSI_PERSON prs ON PRS.PERSON_NR = CPS.PERSON_NR
--		AND PRS.IS_ACTIVE = 1
		INNER JOIN BSI_X_EXT_JOIN_JOIN pjj 
			INNER JOIN BSI_X_EXT_JOIN pj
				INNER JOIN BSI_UC_TEXT uc_person ON uc_person.UC_UID = PJ.INTERFACE_UID AND uc_person.LANGUAGE_UID = 246
			ON PJ.EXT_JOIN_NR = PJJ.EXT_JOIN_NR
			AND PJ.ACTIVE = 1
			AND PJ.EXT_JOIN_TYPE_UID = 108236  -- External Person
			AND PJ.INTERFACE_UID NOT IN (131310)  -- Küba Person
		ON PJJ.JOIN_NR = CPS.PERSON_NR
	ON EJJ.JOIN_NR = CPS.COMPANY_NR
--GROUP BY 
--EJ.INTERFACE_UID || ' - ' || uc_cmp.TEXT 
;