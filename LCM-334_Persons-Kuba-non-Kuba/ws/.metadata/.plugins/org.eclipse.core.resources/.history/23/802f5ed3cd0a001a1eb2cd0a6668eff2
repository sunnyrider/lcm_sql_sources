
SELECT DISTINCT
--	COUNT(CMP.X_COMPLEX_NO) AS Complex_count,
	CMP.X_COMPLEX_NO,
	CMP.COMPANY_NO,
	CMP.DISPLAY_NAME,
	PRS.PERSON_NR,
	CASE WHEN upper(PRS.FIRST_NAME) NOT LIKE 'UNBEKANNT%' 
		AND trim(PRS.FIRST_NAME) NOT IN ('$','*','**','*/',',,','-','--','---','-.',':',';','?','??','^','¨',':','-','0','00')
		AND PRS.FIRST_NAME NOT LIKE '%?%' THEN
			REPLACE(REPLACE(REPLACE(PRS.FIRST_NAME, chr(13), ' '),
				chr(9), ' '), 
				chr(32), ' ')
	ELSE ''
	END first_name,
	CASE WHEN upper(PRS.LAST_NAME) NOT LIKE 'UNBEKANNT%' 
		AND trim(PRS.LAST_NAME) NOT IN ('$','*','**','*/',',,','-','--','---','-.',':',';','?','??','^','¨',':','-','0','00')
		AND PRS.LAST_NAME NOT LIKE '%?%' THEN
			REPLACE(REPLACE(REPLACE(PRS.LAST_NAME, chr(13), ' '),
				chr(9), ' '), 
				chr(32), ' ')
	ELSE ''
	END last_name
FROM BSI_COMPANY_PERSON cps
	INNER JOIN BSI_COMPANY cmp
		INNER JOIN BSI_X_EXT_JOIN_JOIN cjj 
			INNER JOIN BSI_X_EXT_JOIN cj 
			ON CJ.EXT_JOIN_NR = CJJ.EXT_JOIN_NR
			AND CJ.EXT_JOIN_TYPE_UID = CJJ.EXT_JOIN_TYPE_UID
			AND CJ.ACTIVE = 1
		ON CJJ.JOIN_NR = CMP.COMPANY_NR
	ON CMP.COMPANY_NR = CPS.COMPANY_NR
	INNER JOIN BSI_PERSON prs 
		INNER JOIN BSI_X_EXT_JOIN_JOIN PJJ 
			INNER JOIN BSI_X_EXT_JOIN PJ 
			ON PJ.EXT_JOIN_NR = PJJ.EXT_JOIN_NR
			AND PJ.EXT_JOIN_TYPE_UID = PJJ.EXT_JOIN_TYPE_UID
			AND PJ.INTERFACE_UID NOT IN (131310)  -- Küba Person
			AND PJ.EXT_JOIN_TYPE_UID = 108236  -- External Person
			AND PJ.ACTIVE = 1
		ON PJJ.JOIN_NR = PRS.PERSON_NR
	ON PRS.PERSON_NR = CPS.PERSON_NR
WHERE PRS.LAST_NAME IS NOT NULL
AND PRS.FIRST_NAME IS NOT NULL
ORDER BY CMP.X_COMPLEX_NO, PRS.PERSON_NR
;
